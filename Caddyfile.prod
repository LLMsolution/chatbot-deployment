{
    email {$LETSENCRYPT_EMAIL}
}

# Admin upload reverse proxy with increased limits
{$AGENT_API_HOSTNAME} {
    # Security headers
    header {
        # HSTS
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        # Content Security Policy
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.gpteng.co; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self' data: https://r2cdn.perplexity.ai; connect-src 'self' ws: wss: https://cvtclbhzpeptoywuijdt.supabase.co https://api.llm-solution.cloud; media-src 'self' data: blob:; object-src 'none'; frame-src 'none';"
        # Other security headers
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=()"
    }

    # Increased request body size limit for file uploads (5MB)
    request_body {
        max_size 5MB
    }

    # Standard proxy for all endpoints
    reverse_proxy agent-api:8001 {
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

# Frontend reverse proxy
{$FRONTEND_HOSTNAME} {
    # Security headers
    header {
        # HSTS
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        # Content Security Policy
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.gpteng.co; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self' data: https://r2cdn.perplexity.ai; connect-src 'self' ws: wss: https://cvtclbhzpeptoywuijdt.supabase.co https://api.llm-solution.cloud; media-src 'self' data: blob:; object-src 'none'; frame-src 'none';"
        # Other security headers
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=()"
    }

    # Request body size limit (5MB for frontend uploads)
    request_body {
        max_size 5MB
    }

    # Gzip compression
    encode {
        gzip 6
    }

    reverse_proxy frontend:8080 {
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

graph.llmsolution.nl {
    # Security headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
    }

    # Neo4j Browser (HTTP interface)
    reverse_proxy neo4j-graph:7474
}

# Bolt+s proxy - TLS termination door Caddy, dan naar Neo4j Bolt
bolt.llmsolution.nl {
    reverse_proxy neo4j-graph:7687
}

# Website Chatbot API - voor llmsolution.nl frontend op Vercel
api.llmsolution.nl {
    # CORS voor Vercel frontend
    @cors_preflight method OPTIONS
    handle @cors_preflight {
        header Access-Control-Allow-Origin "https://llmsolution.nl"
        header Access-Control-Allow-Methods "GET, POST, OPTIONS"
        header Access-Control-Allow-Headers "Content-Type, Authorization, X-Visitor-IP"
        header Access-Control-Max-Age "86400"
        respond "" 204
    }

    # CORS headers voor alle responses
    header Access-Control-Allow-Origin "https://llmsolution.nl"
    header Access-Control-Allow-Methods "GET, POST, OPTIONS"
    header Access-Control-Allow-Headers "Content-Type, Authorization, X-Visitor-IP"

    # Security headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
    }

    # Request body size limit
    request_body {
        max_size 1MB
    }

    # Proxy naar agent-api
    reverse_proxy agent-api:8001 {
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}
